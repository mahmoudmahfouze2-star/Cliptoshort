<!DOCTYPE html>
<html lang="en">
<head>
   <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4250466001924394"
     crossorigin="anonymous"></script> 
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClipToShort - Upload Short Generator</title>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

<style>
body{
background:#0f0f14;
color:white;
font-family:Arial, sans-serif;
text-align:center;
margin:0;
padding:20px;
}

h1{ color:#7c3aed; }

.container{
max-width:600px;
margin:auto;
}

input, select{
padding:10px;
margin:10px;
width:90%;
border-radius:6px;
border:none;
}

button{
display:inline-block;
padding:12px 25px;
margin:15px;
background:#7c3aed;
color:white;
border:none;
border-radius:8px;
cursor:pointer;
font-size:16px;
}

button:disabled{
opacity:0.6;
cursor:not-allowed;
}

button:hover{
background:#22d3ee;
}

video{
width:100%;
margin-top:20px;
border-radius:8px;
}

.ad-box{
background:#1f1f2e;
padding:25px;
margin:25px auto;
border:1px dashed #7c3aed;
}

.status{
font-weight:bold;
margin-top:10px;
}

#downloadBtn{
display:none;
margin-top:15px;
color:#22c55e;
font-weight:bold;
text-decoration:none;
}

.progress-container{
margin-top:15px;
display:none;
}

.progress-bar-bg{
background:#1f1f2e;
border-radius:6px;
overflow:hidden;
}

.progress-bar{
height:10px;
width:0%;
background:#22c55e;
transition:width 0.2s ease;
}

#timer{
margin-top:8px;
font-size:14px;
color:#facc15;
}
</style>
</head>

<body>

<h1>ClipToShort</h1>
<p>Upload your video and generate a vertical short</p>

<div class="ad-box">Ad Space (Top Banner)</div>

<div class="container">

<input type="file" id="videoInput" accept="video/*">
<p id="uploadStatus" class="status"></p>

<label>Start Time (seconds)</label><br>
<input type="number" id="startTime" value="0">

<label>Duration (seconds)</label><br>
<select id="duration">
<option value="15">15 Seconds</option>
<option value="30">30 Seconds</option>
<option value="60">60 Seconds</option>
</select>

<button id="generateBtn" type="button">Generate Vertical Short</button>

<div class="progress-container" id="progressContainer">
  <div class="progress-bar-bg">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div id="timer">0s</div>
</div>

<div class="ad-box">Ad Space (Before Processing)</div>

<video id="videoPlayer" controls></video>
<a id="downloadBtn" download="short.mp4">Download Short</a>

</div>

<script>
const ffmpeg = FFmpeg.createFFmpeg({ log: false });
const fetchFile = FFmpeg.fetchFile;

let input = document.getElementById("videoInput");
let statusText = document.getElementById("uploadStatus");
let video = document.getElementById("videoPlayer");
let downloadBtn = document.getElementById("downloadBtn");
let progressBar = document.getElementById("progressBar");
let progressContainer = document.getElementById("progressContainer");
let timerText = document.getElementById("timer");
let generateBtn = document.getElementById("generateBtn");

let uploadedFile = null;
let timerInterval = null;
let secondsCounter = 0;

input.addEventListener("change", async function(){
    uploadedFile = input.files[0];

    if(!uploadedFile) return;

    statusText.innerText = "Checking video format...";
    statusText.style.color = "#facc15";

    const tempVideo = document.createElement("video");
    tempVideo.src = URL.createObjectURL(uploadedFile);

    await tempVideo.play().catch(()=>{});
    tempVideo.pause();

    const width = tempVideo.videoWidth;
    const height = tempVideo.videoHeight;

    if(width > height){
        statusText.innerText = "❌ Wide videos are not allowed. Upload vertical video.";
        statusText.style.color = "#ef4444";
        uploadedFile = null;
        return;
    }

    statusText.innerText = "Video Ready ✅";
    statusText.style.color = "#22c55e";
    video.src = URL.createObjectURL(uploadedFile);
    downloadBtn.style.display = "none";
});

generateBtn.addEventListener("click", generatePreview);

async function generatePreview(){

    if(!uploadedFile){
        alert("Upload a vertical video first");
        return;
    }

    generateBtn.disabled = true;
    progressContainer.style.display = "block";
    progressBar.style.width = "0%";
    downloadBtn.style.display = "none";

    statusText.innerText = "Processing video...";
    statusText.style.color = "#facc15";

    secondsCounter = 0;
    timerText.innerText = "0s";

    timerInterval = setInterval(() => {
        secondsCounter++;
        timerText.innerText = secondsCounter + "s";
    }, 1000);

    const start = document.getElementById("startTime").value;
    const duration = document.getElementById("duration").value;

    if(!ffmpeg.isLoaded()){
        await ffmpeg.load();
    }

    ffmpeg.setProgress(({ ratio }) => {
        progressBar.style.width = Math.round(ratio * 100) + "%";
    });

    ffmpeg.FS("writeFile", "input.mp4", await fetchFile(uploadedFile));

    // ضغط ذكي حسب الطول
    let crfValue = 23;
    if(duration <= 15) crfValue = 20;
    if(duration >= 60) crfValue = 26;

    await ffmpeg.run(
        "-ss", start,
        "-t", duration,
        "-i", "input.mp4",
        "-vf", "scale=720:1280:force_original_aspect_ratio=increase,crop=720:1280",
        "-c:v", "libx264",
        "-preset", "fast",
        "-crf", crfValue.toString(),
        "-c:a", "aac",
        "-b:a", "128k",
        "output.mp4"
    );

    const data = ffmpeg.FS("readFile", "output.mp4");
    const url = URL.createObjectURL(
        new Blob([data.buffer], { type: "video/mp4" })
    );

    video.src = url;

    clearInterval(timerInterval);
    timerText.innerText = "Completed ✅";

    downloadBtn.href = url;
    downloadBtn.style.display = "inline-block";

    statusText.innerText = "Vertical Short Generated ✅";
    statusText.style.color = "#22c55e";

    generateBtn.disabled = false;
}
</script>

</body>
</html>
